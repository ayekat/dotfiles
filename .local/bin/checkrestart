#!/usr/bin/env sh

# Checks for processes that need a restart after upgrading.
# Written by progandy on 2014-06-12, and shared on:
# https://bbs.archlinux.org/viewtopic.php?pid=1425075#p1425075

__pids="$(sudo lsof -F pfn |
    awk '
        /^n/{
            # if this file is a deleted library or binary, show it
            if (del == 1 && match($0, "bin|lib")) {
                print pid;
                del=0;
            }
            del = 0;
        }
        /^fDEL$/{
            # the next file is deleted
            del = 1;
        }
        /^p/{
            # we check a new process
            del = 0
            pid = substr($0, 2)
        }' |
    sort -un |
    paste -sd ' '
)"  && [ -n "$__pids" ] && ps -p "$__pids" && unset __pids || unset __pids
